name: Infrastructure Plan

on:
  pull_request:
    paths:
      - 'frappe_terraform/**'
      - '.github/workflows/infra-*.yml'
  workflow_dispatch:
    inputs:
      provider:
        description: 'Cloud provider to plan'
        required: true
        default: 'hetzner'
        type: choice
        options:
          - hetzner
          - digitalocean
          - vultr
          - aws
          - gcp
          - ovhcloud
          - e2enetworks

env:
  TF_VERSION: '1.6.0'

jobs:
  detect-changes:
    name: Detect Changed Providers
    runs-on: ubuntu-latest
    outputs:
      providers: ${{ steps.detect.outputs.providers }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Detect changed providers
        id: detect
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - use selected provider
            echo "providers=[\"${{ github.event.inputs.provider }}\"]" >> $GITHUB_OUTPUT
          else
            # PR trigger - detect changed provider directories
            CHANGED_PROVIDERS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | \
              grep '^frappe_terraform/providers/' | \
              cut -d'/' -f3 | \
              sort -u | \
              jq -R -s -c 'split("\n") | map(select(length > 0))')

            if [ "$CHANGED_PROVIDERS" == "[]" ] || [ -z "$CHANGED_PROVIDERS" ]; then
              # If no specific provider changed, or modules changed, plan all
              echo "providers=[\"hetzner\",\"digitalocean\",\"vultr\",\"aws\",\"gcp\",\"ovhcloud\",\"e2enetworks\"]" >> $GITHUB_OUTPUT
            else
              echo "providers=$CHANGED_PROVIDERS" >> $GITHUB_OUTPUT
            fi
          fi

  plan:
    name: Plan - ${{ matrix.provider }}
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        provider: ${{ fromJson(needs.detect-changes.outputs.providers) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure Terraform Variables - Hetzner
        if: matrix.provider == 'hetzner'
        working-directory: ./frappe_terraform/providers/hetzner
        run: |
          cat > terraform.tfvars <<EOF
          hcloud_token    = "${{ secrets.HCLOUD_TOKEN }}"
          ssh_key_names   = ${{ secrets.HETZNER_SSH_KEY_NAMES || '["default"]' }}
          project_name    = "${{ vars.PROJECT_NAME || 'frappe' }}"
          environment     = "${{ vars.ENVIRONMENT || 'production' }}"
          server_type     = "${{ vars.HETZNER_SERVER_TYPE || 'cx31' }}"
          server_location = "${{ vars.HETZNER_LOCATION || 'fsn1' }}"
          EOF

      - name: Configure Terraform Variables - DigitalOcean
        if: matrix.provider == 'digitalocean'
        working-directory: ./frappe_terraform/providers/digitalocean
        run: |
          cat > terraform.tfvars <<EOF
          do_token       = "${{ secrets.DIGITALOCEAN_TOKEN }}"
          ssh_key_names  = ${{ secrets.DIGITALOCEAN_SSH_KEY_NAMES || '["default"]' }}
          project_name   = "${{ vars.PROJECT_NAME || 'frappe' }}"
          environment    = "${{ vars.ENVIRONMENT || 'production' }}"
          droplet_size   = "${{ vars.DIGITALOCEAN_DROPLET_SIZE || 's-4vcpu-8gb' }}"
          region         = "${{ vars.DIGITALOCEAN_REGION || 'fra1' }}"
          EOF

      - name: Configure Terraform Variables - Vultr
        if: matrix.provider == 'vultr'
        working-directory: ./frappe_terraform/providers/vultr
        run: |
          cat > terraform.tfvars <<EOF
          vultr_api_key  = "${{ secrets.VULTR_API_KEY }}"
          ssh_key_ids    = ${{ secrets.VULTR_SSH_KEY_IDS || '[]' }}
          project_name   = "${{ vars.PROJECT_NAME || 'frappe' }}"
          environment    = "${{ vars.ENVIRONMENT || 'production' }}"
          plan           = "${{ vars.VULTR_PLAN || 'vc2-4c-8gb' }}"
          region         = "${{ vars.VULTR_REGION || 'fra' }}"
          EOF

      - name: Configure Terraform Variables - AWS
        if: matrix.provider == 'aws'
        working-directory: ./frappe_terraform/providers/aws
        run: |
          cat > terraform.tfvars <<EOF
          aws_access_key = "${{ secrets.AWS_ACCESS_KEY_ID }}"
          aws_secret_key = "${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          ssh_key_name   = "${{ secrets.AWS_SSH_KEY_NAME || 'default' }}"
          project_name   = "${{ vars.PROJECT_NAME || 'frappe' }}"
          environment    = "${{ vars.ENVIRONMENT || 'production' }}"
          instance_type  = "${{ vars.AWS_INSTANCE_TYPE || 't3.large' }}"
          region         = "${{ vars.AWS_REGION || 'eu-central-1' }}"
          EOF

      - name: Configure Terraform Variables - GCP
        if: matrix.provider == 'gcp'
        working-directory: ./frappe_terraform/providers/gcp
        run: |
          # Write GCP credentials to file
          echo '${{ secrets.GCP_CREDENTIALS_JSON }}' > /tmp/gcp-credentials.json

          cat > terraform.tfvars <<EOF
          gcp_credentials_file = "/tmp/gcp-credentials.json"
          project_id           = "${{ secrets.GCP_PROJECT_ID }}"
          ssh_public_key       = "${{ secrets.GCP_SSH_PUBLIC_KEY }}"
          project_name         = "${{ vars.PROJECT_NAME || 'frappe' }}"
          environment          = "${{ vars.ENVIRONMENT || 'production' }}"
          machine_type         = "${{ vars.GCP_MACHINE_TYPE || 'e2-standard-2' }}"
          region               = "${{ vars.GCP_REGION || 'europe-west3' }}"
          zone                 = "${{ vars.GCP_ZONE || 'europe-west3-a' }}"
          EOF

      - name: Configure Terraform Variables - OVHcloud
        if: matrix.provider == 'ovhcloud'
        working-directory: ./frappe_terraform/providers/ovhcloud
        run: |
          cat > terraform.tfvars <<EOF
          ovh_endpoint           = "${{ vars.OVH_ENDPOINT || 'ovh-eu' }}"
          ovh_application_key    = "${{ secrets.OVH_APPLICATION_KEY }}"
          ovh_application_secret = "${{ secrets.OVH_APPLICATION_SECRET }}"
          ovh_consumer_key       = "${{ secrets.OVH_CONSUMER_KEY }}"
          openstack_username     = "${{ secrets.OVH_OPENSTACK_USERNAME }}"
          openstack_password     = "${{ secrets.OVH_OPENSTACK_PASSWORD }}"
          openstack_tenant_name  = "${{ secrets.OVH_OPENSTACK_TENANT }}"
          ssh_key_name           = "${{ secrets.OVH_SSH_KEY_NAME || 'default' }}"
          project_name           = "${{ vars.PROJECT_NAME || 'frappe' }}"
          environment            = "${{ vars.ENVIRONMENT || 'production' }}"
          flavor_name            = "${{ vars.OVH_FLAVOR || 'd2-8' }}"
          region                 = "${{ vars.OVH_REGION || 'GRA11' }}"
          EOF

      - name: Configure Terraform Variables - E2E Networks
        if: matrix.provider == 'e2enetworks'
        working-directory: ./frappe_terraform/providers/e2enetworks
        run: |
          cat > terraform.tfvars <<EOF
          e2e_api_key    = "${{ secrets.E2E_API_KEY }}"
          ssh_key_ids    = ${{ secrets.E2E_SSH_KEY_IDS || '[]' }}
          project_name   = "${{ vars.PROJECT_NAME || 'frappe' }}"
          environment    = "${{ vars.ENVIRONMENT || 'production' }}"
          plan_name      = "${{ vars.E2E_PLAN || 'C-4vCPU-8RAM' }}"
          region         = "${{ vars.E2E_REGION || 'Delhi-NCR' }}"
          EOF

      - name: Terraform Init
        working-directory: ./frappe_terraform/providers/${{ matrix.provider }}
        run: terraform init

      - name: Terraform Format Check
        working-directory: ./frappe_terraform/providers/${{ matrix.provider }}
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Validate
        working-directory: ./frappe_terraform/providers/${{ matrix.provider }}
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: ./frappe_terraform/providers/${{ matrix.provider }}
        run: |
          terraform plan -no-color -out=tfplan 2>&1 | tee plan_output.txt
          echo "plan_output<<EOF" >> $GITHUB_OUTPUT
          cat plan_output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Comment Plan on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const provider = '${{ matrix.provider }}';
            const planOutput = `${{ steps.plan.outputs.plan_output }}`.substring(0, 60000);

            const output = `#### Terraform Plan for \`${provider}\` ðŸ“–

            \`\`\`terraform
            ${planOutput || 'Plan output not available'}
            \`\`\`

            *Provider: ${provider} | Pushed by: @${{ github.actor }}*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

      - name: Plan Summary
        run: |
          echo "## Terraform Plan - ${{ matrix.provider }} ðŸ“‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```terraform' >> $GITHUB_STEP_SUMMARY
          head -100 ./frappe_terraform/providers/${{ matrix.provider }}/plan_output.txt >> $GITHUB_STEP_SUMMARY || echo "No plan output"
          echo '```' >> $GITHUB_STEP_SUMMARY
